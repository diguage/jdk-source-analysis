== CountDownLatch

include::_attributes.adoc[]

"Count Down" åœ¨è‹±è¯­ä¸­æ„ä¸ºå€’è®¡æ•°ï¼Œä¸€ä¸ªå…¸å‹åœºæ™¯å°±æ˜¯ç«ç®­ğŸš€å‘å°„æ—¶çš„å€’è®¡æ—¶ã€‚


[source,java,{source_attr}]
----
include::{sourcedir}/concurrent/CountDownLatchTest.java[]
----

ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹çœ‹ `CountDownLatch` æºç ï¼š

`CountDownLatch` ç±»ä¸­å­˜åœ¨ä¸€ä¸ªå†…éƒ¨ç±» `Sync`ï¼Œç»§æ‰¿è‡ª `AbstractQueuedSynchronizer`ï¼Œä»£ç å¦‚ä¸‹ï¼š

[source,java,{source_attr}]
----
/**
 * Synchronization control For CountDownLatch.
 * Uses AQS state to represent count.
 */
private static final class Sync extends AbstractQueuedSynchronizer {
    private static final long serialVersionUID = 4982264981922014374L;

    Sync(int count) {
        setState(count);
    }

    int getCount() {
        return getState();
    }

    protected int tryAcquireShared(int acquires) {
        return (getState() == 0) ? 1 : -1;
    }

    protected boolean tryReleaseShared(int releases) {
        // Decrement count; signal when transition to zero
        for (;;) {
            int c = getState();
            if (c == 0)
                return false;
            int nextc = c - 1;
            if (compareAndSetState(c, nextc))
                return nextc == 0;
        }
    }
}

private final Sync sync;
----

ç®¡ä¸­çª¥è±¹ï¼Œä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡º `CountDownLatch` ä¸­çš„ç­‰å¾…æ§åˆ¶å‡ ä¹éƒ½æ˜¯ä¾èµ– `AbstractQueuedSynchronizer` æ¥å®ç°çš„ã€‚

=== `countDown()`

[source,java,{source_attr}]
----
/**
 * Decrements the count of the latch, releasing all waiting threads if
 * the count reaches zero.
 *
 * <p>If the current count is greater than zero then it is decremented.
 * If the new count is zero then all waiting threads are re-enabled for
 * thread scheduling purposes.
 *
 * <p>If the current count equals zero then nothing happens.
 */
public void countDown() {
    sync.releaseShared(1);
}
----

`countDown()` æ–¹æ³•ç›´æ¥å‡å°‘é”å­˜å™¨è®¡æ•°ï¼Œç›´åˆ°é›¶ï¼Œåˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚

image::images/CountDownLatch-countDown-1.png[]

image::images/CountDownLatch-countDown-2.png[]

=== `await()`

[source,java,{source_attr}]
----
/**
 * Causes the current thread to wait until the latch has counted down to
 * zero, unless the thread is {@linkplain Thread#interrupt interrupted}.
 *
 * <p>If the current count is zero then this method returns immediately.
 *
 * <p>If the current count is greater than zero then the current
 * thread becomes disabled for thread scheduling purposes and lies
 * dormant until one of two things happen:
 * <ul>
 * <li>The count reaches zero due to invocations of the
 * {@link #countDown} method; or
 * <li>Some other thread {@linkplain Thread#interrupt interrupts}
 * the current thread.
 * </ul>
 *
 * <p>If the current thread:
 * <ul>
 * <li>has its interrupted status set on entry to this method; or
 * <li>is {@linkplain Thread#interrupt interrupted} while waiting,
 * </ul>
 * then {@link InterruptedException} is thrown and the current thread's
 * interrupted status is cleared.
 *
 * @throws InterruptedException if the current thread is interrupted
 *         while waiting
 */
public void await() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
----

å¯¹ `await()` çš„å¤„ç†ç›´æ¥å§”æ‰˜ç»™äº† `sync` çš„ `acquireSharedInterruptibly(1)` æ–¹æ³•ï¼Œå½“ç„¶è¿™ä¸ªæ–¹æ³•æ˜¯ä» `AbstractQueuedSynchronizer` ç»§æ‰¿è€Œæ¥çš„ã€‚

image::images/CountDownLatch-await-park.png[]

image::images/CountDownLatch-await-unpark.png[]

[qanda]
`CountDownLatch` ä¸ºä»€ä¹ˆä½¿ç”¨å…±äº«é”ï¼Ÿ::
ç­”ï¼šå‰é¢æˆ‘ä»¬åˆ†æ `ReentrantReadWriteLock` çš„æ—¶å€™å­¦ä¹ è¿‡AQSçš„å…±äº«é”æ¨¡å¼ï¼Œæ¯”å¦‚å½“å‰é”æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹è·å–ä¸ºäº’æ–¥é”ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æ‰€æœ‰éœ€è¦è·å–å…±äº«é”çš„çº¿ç¨‹éƒ½è¦è¿›å…¥AQSé˜Ÿåˆ—ä¸­è¿›è¡Œæ’é˜Ÿï¼Œå½“è¿™ä¸ªäº’æ–¥é”é‡Šæ”¾çš„æ—¶å€™ï¼Œä¼šä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°å”¤é†’è¿™äº›è¿ç»­çš„æ’é˜Ÿçš„ç­‰å¾…è·å–å…±äº«é”çš„çº¿ç¨‹ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ç”¨è¯­æ˜¯â€œä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°å”¤é†’â€ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›ç­‰å¾…è·å–å…±äº«é”çš„çº¿ç¨‹ä¸æ˜¯ä¸€æ¬¡æ€§å”¤é†’çš„ã€‚

=== å‚è€ƒèµ„æ–™

. https://www.cnblogs.com/leesf456/p/5406191.html[ã€JUCã€‘JDK1.8æºç åˆ†æä¹‹CountDownLatchï¼ˆäº”ï¼‰ - leesf - åšå®¢å›­]
. https://juejin.im/post/5d0660f2518825092c7170dd[æ­»ç£• javaåŒæ­¥ç³»åˆ—ä¹‹CountDownLatchæºç è§£æ - æ˜é‡‘]

