<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<meta name="keywords" content="Java,JDK,Java source,Collection,ArrayList,Map,List,HashMap,ArrayDeque,Deque,Set,HashSet,LinkedList,Queue,TreeMap,TreeSet,Vector,Stack">
<meta name="author" content="Dç“œå“¥">
<meta name="copyright" content="Apache-2.0">
<meta property="og:title" content="java.util.ArrayList">
<title>JDK æºç åˆ†æ: 8. </title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="assets/styles/asciidoctor.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/styles/rouge-github.css">
<style>
    a {
        text-decoration: none;
    }

    .img_bk {
        text-align: center;
    }

    p > code, strong > code, div.admonitionblock tr > td.content > code {
        color: #d14 !important;
        background-color: #f5f5f5 !important;
        border: 1px solid #e1e1e8;
        white-space: nowrap;
        border-radius: 3px;
    }
</style>
<link rel="stylesheet" href="assets/styles/asciidoctor-tabs.css">
<style>.toc-current{color:#d14;font-size:130%;font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="java.util.ArrayList" class="book toc2 toc-left">
<div id="header">
<h1>JDK æºç åˆ†æ: 8. </h1>
<div class="details">
<span id="author" class="author">Dç“œå“¥</span><br>
<span id="email" class="email"><a href="https://www.diguage.com" class="bare">https://www.diguage.com</a></span><br>
<span id="revdate">2025-11-25</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="index.html">JDK æºç åˆ†æ</a></span></p><ul class="sectlevel1">
<li><a href="preface.html">å‰è¨€ï¼šJDK &amp; STL æºç åˆ†æè®¡åˆ’</a>
</li>
<li><a href="overview.html">1. é›†åˆç±»æ¦‚è¿°</a>
</li>
<li><a href="java.util.Iterator.html">2. è¿­ä»£å™¨ Iteratorã€ Enumerationã€ Spliterator ä¸ Iterable</a>
</li>
<li><a href="java.util.Collection.html">3. Collection</a>
</li>
<li><a href="java.util.AbstractCollection.html">4. AbstractCollection</a>
</li>
<li><a href="java.util.List.html">5. List</a>
</li>
<li><a href="java.util.AbstractList.html">6. AbstractList</a>
</li>
<li><a href="java.util.AbstractSequentialList.html">7. AbstractSequentialList</a>
</li>
<li><a href="java.util.ArrayList.html"><span class="toc-current">8. <code>ArrayList</code></span></a>
</li>
<li><a href="java.util.LinkedList.html">9. LinkedList</a>
</li>
<li><a href="java.util.Stack.html">10. Stack</a>
</li>
<li><a href="java.util.Vector.html">11. Vector</a>
</li>
<li><a href="java.util.Set.html">12. Set</a>
</li>
<li><a href="java.util.AbstractSet.html">13. AbstractSet</a>
</li>
<li><a href="java.util.SortedSet.html">14. SortedSet</a>
</li>
<li><a href="java.util.NavigableSet.html">15. NavigableSet</a>
</li>
<li><a href="java.util.HashSet.html">16. HashSet</a>
</li>
<li><a href="java.util.TreeSet.html">17. TreeSet</a>
</li>
<li><a href="java.util.LinkedHashSet.html">18. LinkedHashSet</a>
</li>
<li><a href="java.util.BitSet.html">19. BitSet</a>
</li>
<li><a href="java.util.EnumSet.html">20. EnumSet</a>
</li>
<li><a href="java.util.Map.html">21. Map</a>
</li>
<li><a href="java.util.SortedMap.html">22. SortedMap</a>
</li>
<li><a href="java.util.NavigableMap.html">23. NavigableMap</a>
</li>
<li><a href="java.util.AbstractMap.html">24. AbstractMap</a>
</li>
<li><a href="java.util.HashMap.html">25. HashMap</a>
</li>
<li><a href="java.util.TreeMap.html">26. TreeMap</a>
</li>
<li><a href="java.util.LinkedHashMap.html">27. LinkedHashMap</a>
</li>
<li><a href="java.util.Dictionary.html">28. Dictionary</a>
</li>
<li><a href="java.util.Hashtable.html">29. Hashtable</a>
</li>
<li><a href="java.util.EnumMap.html">30. EnumMap</a>
</li>
<li><a href="java.util.WeakHashMap.html">31. WeakHashMap</a>
</li>
<li><a href="java.util.IdentityHashMap.html">32. IdentityHashMap</a>
</li>
<li><a href="java.util.Queue.html">33. Queue</a>
</li>
<li><a href="java.util.Deque.html">34. Deque</a>
</li>
<li><a href="java.util.AbstractQueue.html">35. AbstractQueue</a>
</li>
<li><a href="java.util.ArrayDeque.html">36. ArrayDeque</a>
</li>
<li><a href="java.util.PriorityQueue.html">37. PriorityQueue</a>
</li>
<li><a href="java.util.Array.html">38. å·¥å…·ç±» <code>Arrays</code></a>
</li>
<li><a href="java.util.Collection.html">39. å·¥å…·ç±» <code>Collections</code></a>
</li>
<li><a href="concurrent.overview.html">40. å¹¶å‘åº“æ¦‚è¿°</a>
</li>
<li><a href="java.lang.Thread.html">41. Thread</a>
</li>
<li><a href="java.util.concurrent.locks.LockSupport.html">42. LockSupport</a>
</li>
<li><a href="java.util.concurrent.locks.AbstractQueuedSynchronizer.html">43. AbstractQueuedSynchronizer</a>
</li>
<li><a href="java.util.concurrent.locks.ReentrantLock.html">44. ReentrantLock</a>
</li>
<li><a href="java.util.concurrent.locks.ReentrantReadWriteLock.html">45. ReentrantReadWriteLock</a>
</li>
<li><a href="java.util.concurrent.locks.StampedLock.html">46. StampedLock</a>
</li>
<li><a href="java.util.concurrent.Semaphore.html">47. Semaphore</a>
</li>
<li><a href="java.util.concurrent.CountDownLatch.html">48. CountDownLatch</a>
</li>
<li><a href="java.util.concurrent.CyclicBarrier.html">49. CyclicBarrier</a>
</li>
<li><a href="java.util.concurrent.Phaser.html">50. Phaser</a>
</li>
<li><a href="java.util.concurrent.Exchanger.html">51. Exchanger</a>
</li>
<li><a href="java.lang.ThreadLocal.html">52. ThreadLocal</a>
</li>
<li><a href="java.util.concurrent.atomic.AtomicInteger.html">53. AtomicInteger</a>
</li>
<li><a href="java.util.concurrent.atomic.LongAdder.html">54. LongAdder</a>
</li>
<li><a href="java.util.concurrent.Future.html">55. JUC åŒ…åŸºç¡€ç±»åˆ†æ</a>
</li>
<li><a href="java.util.concurrent.FutureTask.html">56. FutureTask</a>
</li>
<li><a href="java.util.concurrent.CompletableFuture.html">57. CompletableFuture</a>
</li>
<li><a href="java.util.concurrent.ThreadPoolExecutor.html">58. ThreadPoolExecutor æºç åˆ†æ</a>
</li>
<li><a href="java.util.concurrent.ForkJoinTask.html">59. ForkJoinTask</a>
</li>
<li><a href="java.util.concurrent.ForkJoinPool.html">60. ForkJoinPool</a>
</li>
<li><a href="java.util.concurrent.ConcurrentHashMap.html">61. <code>ConcurrentHashMap</code></a>
</li>
<li><a href="java.util.concurrent.ConcurrentSkipListMap.html">62. <code>ConcurrentSkipListMap</code></a>
</li>
<li><a href="java.util.concurrent.CopyOnWriteArrayList.html">63. CopyOnWriteArrayList</a>
</li>
<li><a href="java.util.concurrent.ConcurrentLinkedQueue.html">64. ConcurrentLinkedQueue</a>
</li>
<li><a href="java.util.concurrent.ArrayBlockingQueue.html">65. ArrayBlockingQueue</a>
</li>
<li><a href="java.util.concurrent.LinkedBlockingQueue.html">66. LinkedBlockingQueue</a>
</li>
<li><a href="java.util.concurrent.PriorityBlockingQueue.html">67. PriorityBlockingQueue</a>
</li>
<li><a href="java.util.concurrent.DelayQueue.html">68. DelayQueue</a>
</li>
<li><a href="java.util.concurrent.ScheduledThreadPoolExecutor.html">69. <code>ScheduledThreadPoolExecutor</code></a>
</li>
<li><a href="java.util.concurrent.Flow.html">70. <code>Flow</code></a>
</li>
<li><a href="java.lang.ClassLoader.html">71. ClassLoader</a>
</li>
<li><a href="java.lang.reflect.Field.html">72. Field</a>
</li>
<li><a href="java.lang.reflect.Proxy.html">73. Proxy</a>
</li>
<li><a href="java.net.ServerSocket.html">74. ServerSocket</a>
</li>
<li><a href="java.util.ServiceLoader.html">75. <code>ServiceLoader</code></a>
</li>
<li><a href="java.lang.String.html">76. <code>String</code></a>
</li>
<li><a href="java.util.Date.html">77. <code>Date</code></a>
</li>
<li><a href="java.io.Serializable.html">78. <code>Serializable</code></a>
</li>
<li><a href="java.regex.Pattern.html">79. <code>Pattern</code></a>
</li>
<li><a href="_netty.html">80. Netty</a>
</li>
</ul>
</div>
</div>
<div id="content"><div class="sect2"><h3 id="_å‹æƒ…æ”¯æŒ">å‹æƒ…æ”¯æŒ</h3><div class="paragraph"><p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç è¿™ä¹ˆå¤šå­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p></div><table class="tableblock frame-none grid-all stretch"><colgroup><col style="width: 50%;"><col style="width: 50%;"></colgroup><tbody><tr><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="assets/images/alipay.png" alt="æ”¯ä»˜å®" width="85%" title="æ”¯ä»˜å®"></span></p></td><td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="assets/images/wxpay.jpg" alt="å¾®ä¿¡" width="85%" title="å¾®ä¿¡"></span></p></td></tr></tbody></table><div class="paragraph"><p>æœ‰äº›æ‰“èµçš„æœ‹å‹å¸Œæœ›å¯ä»¥åŠ ä¸ªå¥½å‹ï¼Œæ¬¢è¿å…³æ³¨D ç“œå“¥çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å…¬ä¼—å·çš„å›å¤ç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ã€‚</p></div><div class="paragraph"><p><span class="image"><img src="assets/images/wx-jikerizhi.png" alt="wx jikerizhi" width="98%"></span></p></div><div class="admonitionblock tip"><table><tbody><tr><td class="icon"><i class="fa icon-tip" title="Tip"></i></td><td class="content"><strong>å…¬ä¼—å·çš„å¾®ä¿¡å·æ˜¯: <code>jikerizhi</code></strong>ã€‚<em>å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæœ‰æ—¶å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ã€‚ å¦‚æœå›¾ç‰‡åŠ è½½ä¸å‡ºæ¥å¯ä»¥ç›´æ¥é€šè¿‡æœç´¢å¾®ä¿¡å·æ¥æŸ¥æ‰¾æˆ‘çš„å…¬ä¼—å·ã€‚</em></td></tr></tbody></table></div></div>
<div class="sect1">
<h2 id="java.util.ArrayList"><a class="anchor" href="#java.util.ArrayList"></a>8. <code>ArrayList</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>å¯¹äºæ¯ç§æŠ½è±¡æ•°æ®ç±»å‹å¹¶ä¸å­˜åœ¨ä»€ä¹ˆæ³•åˆ™æ¥å‘Šè¯‰æˆ‘ä»¬å¿…é¡»è¦æœ‰å“ªäº›æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡å†³ç­–ã€‚--ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æã€‹</p>
</div>
<div class="sect2">
<h3 id="_ç±»å›¾_2"><a class="anchor" href="#_ç±»å›¾_2"></a>8.1. ç±»å›¾</h3>
<div class="paragraph">
<p>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>ArrayList</code> çš„ç±»å›¾ï¼š</p>
</div>
<div class="imageblock text-center kroki">
<div class="content">
<img src="./diag-acc239e7466b068c3a24796c244563af0d3cc39a5335cb4341e141595fb51c86.svg" alt="Diagram" width="95%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>æ”¯æŒæ³›å‹ï¼Œç»§æ‰¿äº† <code>AbstractList</code>ï¼Œå®ç°äº† <code>List</code> æ¥å£ã€‚</p>
</li>
<li>
<p><code>RandomAccess</code> ç”¨æ¥è¡¨æ˜å…¶æ”¯æŒå¿«é€Ÿï¼ˆé€šå¸¸æ˜¯å›ºå®šæ—¶é—´ï¼‰éšæœºè®¿é—®ã€‚åœ¨ <code>Collections.binarySearch()</code> æ–¹æ³•ä¸­ï¼Œå®ƒè¦åˆ¤æ–­ä¼ å…¥çš„list æ˜¯å¦ <code>RamdomAccess</code> çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œè°ƒç”¨ <code>Collections.indexedBinarySearch(list, key)</code> æ–¹æ³•ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>Collections.iteratorBinarySearch(list, key)</code> æ–¹æ³•ã€‚</p>
</li>
<li>
<p><code>Cloneable</code> å¯ä»¥è°ƒç”¨ <code>Object.clone()</code> æ–¹æ³•è¿”å›è¯¥å¯¹è±¡çš„æµ…æ‹·è´ã€‚</p>
</li>
<li>
<p><code>Serializable</code> æ­¤ç±»å¯è¢«åºåˆ—åŒ–</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>ä¸ºä»€ä¹ˆè¿˜è¦å†æ¬¡å®ç° <code>List</code> æ¥å£ï¼Ÿï¼ˆå…¶çˆ¶ç±»å·²ç»å®ç°æ­¤æ¥å£éƒ¨åˆ†æ–¹æ³•ï¼š <code>AbstractList</code> å®ç° <code>List</code> æ¥å£ä¸­é™¤ <code>size()</code> , <code>get(int index)</code> ä¹‹å¤–çš„æ‰€æœ‰å‡½æ•°ï¼‰ã€‚</p>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>æŠ½è±¡ç±»å®ç°æ¥å£ï¼Œå¯ä»¥ä¸çœŸæ­£å®ç°æ‰€æœ‰æ–¹æ³•ï¼ˆå¯ä»¥æŠ½è±¡å®ç°ï¼‰ã€‚</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_åˆå§‹åŒ–"><a class="anchor" href="#_åˆå§‹åŒ–"></a>8.2. åˆå§‹åŒ–</h3>
<div class="paragraph">
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>ArrayList</code> çš„åˆå§‹åŒ–ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="cm">/**
 * Default initial capacity.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CAPACITY</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="cm">/**
 * Shared empty array instance used for empty instances.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * Shared empty array instance used for default sized empty instances. We
 * distinguish this from EMPTY_ELEMENTDATA to know how much to inflate when
 * first element is added.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * The array buffer into which the elements of the ArrayList are stored.
 * The capacity of the ArrayList is the length of this array buffer. Any
 * empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
 * will be expanded to DEFAULT_CAPACITY when the first element is added.
 */</span>
<span class="kd">transient</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span> <span class="c1">// non-private to simplify nested class access</span>

<span class="cm">/**
 * The size of the ArrayList (the number of elements it contains).
 *
 * @serial
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

<span class="cm">/**
 * Constructs an empty list with the specified initial capacity.
 *
 * @param  initialCapacity  the initial capacity of the list
 * @throws IllegalArgumentException if the specified initial capacity
 *         is negative
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">initialCapacity</span><span class="o">];</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal Capacity: "</span><span class="o">+</span>
                                           <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs an empty list with an initial capacity of ten.
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs a list containing the elements of the specified
 * collection, in the order they are returned by the collection's
 * iterator.
 *
 * @param c the collection whose elements are to be placed into this list
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">elementData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// defend against c.toArray (incorrectly) not returning Object[]</span>
        <span class="c1">// (see e.g. https://bugs.openjdk.java.net/browse/JDK-6260652)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// replace with empty array.</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çŒœæµ‹ï¼Œ<strong><code>ArrayList</code> å†…éƒ¨ä½¿ç”¨æ•°ç»„æ¥ä¿å­˜å…ƒç´ çš„ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªæ•´å‹ <code>int</code> å˜é‡æ¥ä¿å­˜é•¿åº¦ã€‚</strong></p>
</div>
<div class="paragraph">
<p><code>ArrayList</code> åˆå§‹åŒ–å·¥ä½œåˆ†ä¸‰ç§æƒ…å†µï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ— å‚æ„é€ å‡½æ•°åˆå§‹åŒ–æ—¶ï¼Œç›´æ¥å°†å†…éƒ¨æ•°ç»„åˆå§‹åŒ–ä¸º <code>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</code>ã€‚åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œå†åˆå§‹åŒ–ä¸ºé»˜è®¤å®¹é‡æ˜¯ <code>10</code> çš„æ•°ç»„ã€‚</p>
</li>
<li>
<p>æŒ‡å®šå®¹é‡å¤§å°è¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œå®¹é‡å¤§äº <code>0</code> åˆ™åˆå§‹åŒ–ä¸ºæŒ‡å®šå®¹é‡çš„æ•°ç»„ï¼›å¦‚æœç­‰äº <code>0</code> åˆ™åˆå§‹åŒ–ä¸ºé»˜è®¤ç©ºæ•°ç»„ <code>EMPTY_ELEMENTDATA</code>ã€‚å¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>å¦‚æœä½¿ç”¨ <code>Collection</code> å®ä¾‹æ¥åˆå§‹åŒ–ï¼Œä¸ä¸ºç©ºåˆ™å°†è°ƒç”¨ <code>toArray()</code> æ–¹æ³•æ¥åˆå§‹åŒ– <code>elementData</code>ï¼›å¦‚æœä¸ºç©ºåˆ™åˆå§‹åŒ–ä¸ºé»˜è®¤ç©ºæ•°ç»„ <code>EMPTY_ELEMENTDATA</code>ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_æ·»åŠ å…ƒç´ "><a class="anchor" href="#_æ·»åŠ å…ƒç´ "></a>8.3. æ·»åŠ å…ƒç´ </h3>
<div class="paragraph">
<p>åœ¨è¿›è¡Œæ­£å¸¸æµ‹è¯•å‰ï¼Œå…ˆå±•ç¤ºä¸€ä¸‹"é€è§†" <code>ArrayList</code> çš„å·¥å…·ç±»ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-03 11:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListBaseTest</span> <span class="o">{</span>
    <span class="cm">/**
     * é€šè¿‡åå°„æŸ¥çœ‹ {@link ArrayList} çš„å†…éƒ¨å±æ€§
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">ArrayList</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">elementData</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"elementData"</span><span class="o">);</span>
            <span class="n">elementData</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="nc">Field</span> <span class="n">sizeField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"size"</span><span class="o">);</span>
            <span class="n">sizeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">objects</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                    <span class="o">++</span><span class="n">size</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"length = "</span> <span class="o">+</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span>
                    <span class="o">+</span> <span class="s">", size = "</span> <span class="o">+</span> <span class="n">sizeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">)</span>
                    <span class="o">+</span> <span class="s">", arraySize = "</span> <span class="o">+</span> <span class="n">size</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ­£å¼æµ‹è¯•ï¼šå°†åˆå§‹åŒ–é•¿åº¦è®¾ç½®ä¸º <code>8</code>ï¼ŒåŒæ—¶å°†æ·»åŠ å…ƒç´ çš„ä¸ªæ•°è®¾ç½®ä¸º <code>8 * 2</code> æ¥æ–¹ä¾¿è§‚å¯Ÿæ•°ç»„å¢é•¿æƒ…å†µã€‚é€šè¿‡ä¸Šè¿°çš„å·¥å…·æ–¹æ³•ï¼Œå¯ä»¥å°† <code>ArrayList</code> å†…éƒ¨çš„æ•°æ®è¿›ä¸€æ­¥å±•ç¤ºå‡ºæ¥ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtTail</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK ç›¸å…³æºä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre><span class="cm">/**
 * Increases the capacity to ensure that it can hold at least the
 * number of elements specified by the minimum capacity argument.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span>
                                       <span class="n">newCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">grow</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns a capacity at least as large as the given minimum capacity.
 * Returns the current capacity increased by 50% if that suffices.
 * Will not return a capacity greater than MAX_ARRAY_SIZE unless
 * the given minimum capacity is greater than MAX_ARRAY_SIZE.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">newCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// overflow-conscious code</span>
    <span class="kt">int</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">oldCapacity</span> <span class="o">+</span> <span class="o">(</span><span class="n">oldCapacity</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="n">minCapacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">==</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">)</span>
            <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="no">DEFAULT_CAPACITY</span><span class="o">,</span> <span class="n">minCapacity</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">minCapacity</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">?</span> <span class="n">newCapacity</span>
        <span class="o">:</span> <span class="n">hugeCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">hugeCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
        <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span>
        <span class="o">:</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * This helper method split out from add(E) to keep method
 * bytecode size under 35 (the -XX:MaxInlineSize default value),
 * which helps when add(E) is called in a C1-compiled loop.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">,</span> <span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">s</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="n">add</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ç»è¿‡æµ‹è¯•å‘ç°ï¼Œ<code>ArrayList</code> æ˜¯åœ¨å®¹é‡è¾¾åˆ°æ•°ç»„é•¿åº¦ä¹‹åï¼Œå†æ¬¡æ·»åŠ æ‰ä¼šæ‰©å®¹ï¼Œæ‰©å®¹é•¿åº¦ä¸º <code>int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1)</code>ï¼Œæœ€å°ä¸ºåŸå§‹é•¿åº¦ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ <code>int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8</code>ã€‚</p>
</div>
<div class="paragraph">
<p>ä¹‹æ‰€ä»¥æœ€å¤§é•¿åº¦ä¸º <code>Integer.MAX_VALUE</code> å‡å» <code>8</code>ï¼Œæ–‡æ¡£è§£é‡Šæ˜¯å› ä¸ºæŸäº› VM ä¿ç•™æ•°ç»„å¤´éƒ¨ç”¨äºå­˜å‚¨ä¸€äº› header wordsã€‚ä½†æ˜¯åœ¨ <code>hugeCapacity(int minCapacity)</code> æ–¹æ³•ä¸­ï¼Œåœ¨æœ€å°å®¹é‡å¤§äº <code>MAX_ARRAY_SIZE</code>ï¼Œåˆå¯ä»¥è¿”å› <code>Integer.MAX_VALUE</code>ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cm">/**
 * Inserts the specified element at the specified position in this
 * list. Shifts the element currently at that position (if any) and
 * any subsequent elements to the right (adds one to their indices).
 *
 * @param index index at which the specified element is to be inserted
 * @param element element to be inserted
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">)</span> <span class="o">==</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                     <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                     <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * A version of rangeCheck used by add and addAll.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>ä»è¿™é‡Œçœ‹å‡ºï¼Œåœ¨å¤´éƒ¨æ’å…¥æ·»åŠ å…ƒç´ ï¼Œå®é™…å°±æ˜¯å°†æŒ‡å®šåæ ‡ä½ç½®ä»¥åŠå³ä¾§æ‰€æœ‰å…ƒç´ å‘åç§»åŠ¨ä¸€ä½ï¼Œè…¾å‡ºç©ºé—´å­˜æ”¾æ–°å…ƒç´ ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="code"><pre><span class="cm">/**
 * Appends all of the elements in the specified collection to the end of
 * this list, in the order that they are returned by the
 * specified collection's Iterator.  The behavior of this operation is
 * undefined if the specified collection is modified while the operation
 * is in progress.  (This implies that the behavior of this call is
 * undefined if the specified collection is this list, and this
 * list is nonempty.)
 *
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts all of the elements in the specified collection into this
 * list, starting at the specified position.  Shifts the element
 * currently at that position (if any) and any subsequent elements to
 * the right (increases their indices).  The new elements will appear
 * in the list in the order that they are returned by the
 * specified collection's iterator.
 *
 * @param index index at which to insert the first element from the
 *              specified collection
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws IndexOutOfBoundsException {@inheritDoc}
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numMoved</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                         <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">,</span>
                         <span class="n">numMoved</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>å‘ <code>ArrayList</code> ä¸­æ·»åŠ é›†åˆå®ä¾‹ï¼Œåˆ™æ˜¯é›†åˆç¤ºä¾‹è½¬åŒ–æˆæ•°ç»„ï¼Œç„¶ååˆ©ç”¨æ•°ç»„æ‹·è´çš„æ–¹å¼æ¥é«˜æ•ˆå®Œæˆæ·»åŠ å·¥ä½œã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_åˆ é™¤å…ƒç´ "><a class="anchor" href="#_åˆ é™¤å…ƒç´ "></a>8.4. åˆ é™¤å…ƒç´ </h3>

</div>
<div class="sect2">
<h3 id="_æµ‹è¯•éå†é€Ÿåº¦"><a class="anchor" href="#_æµ‹è¯•éå†é€Ÿåº¦"></a>8.5. æµ‹è¯•éå†é€Ÿåº¦</h3>
<div class="paragraph">
<p><code>ArrayList</code> çš„éå†æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>æ ‡å‡†è¿­ä»£å™¨æ–¹å¼</p>
</li>
<li>
<p>å¤–éƒ¨ <code>for</code> å¾ªç¯ + <code>get(index)</code></p>
</li>
<li>
<p><code>forEach(lambda)</code> æ–¹æ³•</p>
</li>
<li>
<p><code>for(E e: arrayList)</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>åŸºå‡†æµ‹è¯•å½“ç„¶é Java Microbenchmark Harness è«å±äº†ã€‚ç›´æ¥ä¸Šä»£ç ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jmh.annotations.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="cm">/**
 * @author Dç“œå“¥, https://www.diguage.com/
 * @since 2020-03-03 13:09
 */</span>
<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="na">Throughput</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="nd">@State</span><span class="o">(</span><span class="nc">Scope</span><span class="o">.</span><span class="na">Benchmark</span><span class="o">)</span>
<span class="nd">@Threads</span><span class="o">(</span><span class="mi">8</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListIteratorSpeedTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Setup</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">Iteration</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="o">;</span>
        <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">arrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">iteratorValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">iteratorValue</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRandomAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEachLambda</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">arrayList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">devnull</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">devnull</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachLambdaValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Integer</span> <span class="n">integer</span> <span class="o">:</span> <span class="n">arrayList</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">forEachValue</span> <span class="o">=</span> <span class="n">integer</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
</div>
<div class="listingblock">
<div class="content">
<pre></pre>
</div>
</div>
<div class="paragraph">
<p>åœ¨ä»£ç ä¸­ï¼Œå¸¸å¸¸çœ‹åˆ° <code>modCount</code> å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä» <code>AbstractList</code> ç»§æ‰¿åˆ°çš„ä¸€ä¸ªé‡è¦å±æ€§ã€‚ è¿™ä¸ªå±æ€§ç”¨äºåœ¨ä½¿ç”¨è¿­ä»£å™¨ï¼ˆ<code>ListIterator</code>ï¼Œ<code>Iterator</code>ï¼‰éå†çš„æ—¶å€™ï¼Œç”¨æ¥æ£€æŸ¥åˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯å¦å‘ç”Ÿç»“æ„æ€§å˜åŒ–ï¼ˆåˆ—è¡¨å…ƒç´ æ•°é‡å‘ç”Ÿæ”¹å˜ï¼‰äº†ï¼Œä¸»è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦ä½¿ç”¨ï¼Œé˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¿­ä»£éå†ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªåˆ—è¡¨çš„ç»“æ„ã€‚<code>ArrayList</code> æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚<code>writeObject</code>ï¼ˆåºåˆ—åŒ–æ—¶ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ã€‚</p>
</div>
<div class="paragraph">
<p>æ£€æŸ¥åˆ°ä¿®æ”¹ä¸ä¸€è‡´å°±æŠ›å‡ºå¼‚å¸¸æ˜¯ fail-fast æœºåˆ¶ï¼Œæ˜¯ Java é›†åˆ(Collection)ä¸­çš„ä¸€ç§é”™è¯¯æœºåˆ¶ã€‚å®ƒåªèƒ½è¢«ç”¨æ¥æ£€æµ‹é”™è¯¯ï¼Œå› ä¸ºJDKå¹¶ä¸ä¿è¯ fail-fast æœºåˆ¶ä¸€å®šä¼šå‘ç”Ÿã€‚å¦‚æœå‘ç”Ÿ fail-fastï¼Œåˆ™æ¨èä½¿ç”¨ <code>JUC</code> ä¸­å¯¹åº”çš„ç±»ã€‚</p>
</div>
<div class="paragraph">
<p>ç®€å•æ¥è¯´ï¼ŒJava çš„åºåˆ—åŒ–æœºåˆ¶æ˜¯é€šè¿‡åœ¨è¿è¡Œæ—¶åˆ¤æ–­ç±»çš„ <code>serialVersionUID</code> æ¥éªŒè¯ç‰ˆæœ¬ä¸€è‡´æ€§çš„ã€‚åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼ŒJVMä¼šæŠŠä¼ æ¥çš„å­—èŠ‚æµä¸­çš„ <code>serialVersionUID</code> ä¸æœ¬åœ°ç›¸åº”å®ä½“ï¼ˆç±»ï¼‰çš„ <code>serialVersionUID</code> è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒå°±è®¤ä¸ºæ˜¯ä¸€è‡´çš„ï¼Œå¯ä»¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå¦åˆ™å°±ä¼šå‡ºç°åºåˆ—åŒ–ç‰ˆæœ¬ä¸ä¸€è‡´çš„å¼‚å¸¸ã€‚(InvalidCastException)</p>
</div>
<div class="paragraph">
<p><code>serialVersionUID</code> æœ‰ä¸¤ç§æ˜¾ç¤ºçš„ç”Ÿæˆæ–¹å¼ï¼š</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ä¸€ä¸ªæ˜¯é»˜è®¤çš„Lç±»å‹æ•°å­—ï¼Œæ¯”å¦‚ï¼šprivate static final long serialVersionUID = 1L;</p>
</li>
<li>
<p>ä¸€ä¸ªæ˜¯æ ¹æ®ç±»åã€æ¥å£åã€æˆå‘˜æ–¹æ³•åŠå±æ€§ç­‰æ¥ç”Ÿæˆä¸€ä¸ª64ä½çš„å“ˆå¸Œå­—æ®µã€‚</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>å½“å®ç° <code>java.io.Serializable</code> æ¥å£çš„å®ä½“ï¼ˆç±»ï¼‰æ²¡æœ‰æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªåä¸º <code>serialVersionUID</code>ï¼Œç±»å‹ä¸º <code>long</code> çš„å˜é‡æ—¶ï¼ŒJavaåºåˆ—åŒ–æœºåˆ¶ä¼šæ ¹æ®ç¼–è¯‘çš„class(å®ƒé€šè¿‡ç±»åï¼Œæ–¹æ³•åç­‰è¯¸å¤šå› ç´ ç»è¿‡è®¡ç®—è€Œå¾—ï¼Œç†è®ºä¸Šæ˜¯ä¸€ä¸€æ˜ å°„çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å”¯ä¸€çš„)è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>serialVersionUID</code> ä½œåºåˆ—åŒ–ç‰ˆæœ¬æ¯”è¾ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœclassæ–‡ä»¶(ç±»å,æ–¹æ³•æ˜ç­‰)æ²¡æœ‰å‘ç”Ÿå˜åŒ–(å¢åŠ ç©ºæ ¼,æ¢è¡Œ,å¢åŠ æ³¨é‡Š,ç­‰ç­‰)ï¼Œå°±ç®—å†ç¼–è¯‘å¤šæ¬¡ï¼Œ<code>serialVersionUID</code> ä¹Ÿä¸ä¼šå˜åŒ–çš„.</p>
</div>
<div class="paragraph">
<p>å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›é€šè¿‡ç¼–è¯‘æ¥å¼ºåˆ¶åˆ’åˆ†è½¯ä»¶ç‰ˆæœ¬ï¼Œå³å®ç°åºåˆ—åŒ–æ¥å£çš„å®ä½“èƒ½å¤Ÿå…¼å®¹å…ˆå‰ç‰ˆæœ¬ï¼Œæœªä½œæ›´æ”¹çš„ç±»ï¼Œå°±éœ€è¦æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªåä¸º <code>serialVersionUID</code>ï¼Œç±»å‹ä¸º <code>long</code> çš„å˜é‡ï¼Œä¸ä¿®æ”¹è¿™ä¸ªå˜é‡å€¼çš„åºåˆ—åŒ–å®ä½“éƒ½å¯ä»¥ç›¸äº’è¿›è¡Œä¸²è¡ŒåŒ–å’Œåä¸²è¡ŒåŒ–ã€‚</p>
</div>
<div class="paragraph">
<p>3.è§‚å¯Ÿ3ä¸¤ä¸ªé‡è¦å±æ€§
å…³é”®å­— transientï¼ˆç¬æ€ï¼‰è¢«æ ‡è®°ä¸ºtransientçš„å±æ€§åœ¨å¯¹è±¡è¢«åºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šè¢«ä¿å­˜ã€‚
why?
å‡å¦‚elementDataçš„é•¿åº¦ä¸º10ï¼Œè€Œå…¶ä¸­åªæœ‰5ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆåœ¨åºåˆ—åŒ–çš„æ—¶å€™åªéœ€è¦å­˜å‚¨5ä¸ªå…ƒç´ ï¼Œè€Œæ•°ç»„ä¸­åé¢5ä¸ªå…ƒç´ æ˜¯ä¸éœ€è¦å­˜å‚¨çš„ã€‚äºæ˜¯å°†elementDataå®šä¹‰ä¸ºtransientï¼Œé¿å…äº†Javaè‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶ï¼Œå¹¶å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ç°äº†è‡ªå·±å¯æ§åˆ¶çš„åºåˆ—åŒ–æ“ä½œã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//æ›´æ–°</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
	<span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//æŸ¥æ‰¾</span>

<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="k">return</span> <span class="nf">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//æ˜¯å¦åŒ…å«</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">indexOf</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">indexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//åå‘æŸ¥æ‰¾</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">lastIndexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//å®¹é‡åˆ¤æ–­</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>1.æµ…å…‹éš†ï¼ˆshallow cloneï¼‰</p>
</div>
<div class="paragraph">
<p>è¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰åŸºç¡€ç±»å‹å˜é‡ï¼ˆbyte,short,int,long,char,boolean,float,doubleï¼‰ä¸åŸæœ‰å¯¹è±¡ä¸­å˜é‡å…·æœ‰ç›¸åŒçš„å€¼ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ï¼›è€Œå¤åˆ¶å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹ï¼ˆæ•°ç»„ï¼Œç±»å¯¹è±¡ç­‰ï¼‰è¿˜æ˜¯æŒ‡å‘åŸæ¥å¯¹è±¡ï¼Œä¿®æ”¹å…¶å€¼ä¼šå½±å“åŸå¯¹è±¡ã€‚</p>
</div>
<div class="paragraph">
<p>2.æ·±å…‹éš†ï¼ˆdeep cloneï¼‰</p>
</div>
<div class="paragraph">
<p>è¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰åŸºç¡€ç±»å‹å˜é‡ï¼ˆbyte,short,int,long,char,boolean,float,doubleï¼‰ä¸åŸæœ‰å¯¹è±¡ä¸­å˜é‡å…·æœ‰ç›¸åŒçš„å€¼ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ï¼›å¹¶ä¸”å¤åˆ¶å¯¹è±¡ä¸­å¼•ç”¨ç±»å‹ï¼ˆæ•°ç»„ï¼Œç±»å¯¹è±¡ç­‰ï¼‰æŒ‡å‘è¢«å¤åˆ¶è¿‡çš„æ–°å¯¹è±¡ï¼Œä¿®æ”¹å…¶å€¼ä¸ä¼šå½±å“åŸå¯¹è±¡ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="nc">ArrayList</span><span class="o">&lt;?&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;?&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
		<span class="n">v</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="n">v</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">v</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// this shouldn't happen, since we are Cloneable</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="c1">// Make a new array of a's runtime type, but my contents:</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="n">a</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Positional Access Operations</span>
<span class="c1">//å¾—åˆ°æŒ‡å®šç´¢å¼•å¤„çš„å…ƒç´ </span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="no">E</span> <span class="nf">elementData</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
<span class="o">}</span>
<span class="c1">//æ¸…ç©º</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>
	<span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">toIndex</span><span class="o">;</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span>
					 <span class="n">numMoved</span><span class="o">);</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="o">(</span><span class="n">toIndex</span><span class="o">-</span><span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
<span class="o">}</span>

 <span class="c1">//æ£€æŸ¥æ•°å¦è¶…å‡ºæ•°ç»„é•¿åº¦ ç”¨äºæ·»åŠ å…ƒç´ æ—¶</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
<span class="c1">//æ£€æŸ¥æ˜¯å¦æº¢å‡º</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="n">size</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//åˆ é™¤æŒ‡å®šé›†åˆçš„å…ƒç´ </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//ä»…ä¿ç•™æŒ‡å®šé›†åˆçš„å…ƒç´ </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">*</span> <span class="nd">@param</span> <span class="n">complement</span> <span class="n">trueæ—¶ä»æ•°ç»„ä¿ç•™æŒ‡å®šé›†åˆä¸­å…ƒç´ çš„å€¼</span><span class="err">ï¼Œ</span><span class="n">ä¸ºfalseæ—¶ä»æ•°ç»„åˆ é™¤æŒ‡å®šé›†åˆä¸­å…ƒç´ çš„å€¼</span><span class="err">ã€‚</span>
<span class="o">*</span> <span class="nd">@return</span> <span class="n">æ•°ç»„ä¸­é‡å¤çš„å…ƒç´ éƒ½ä¼šè¢«åˆ é™¤</span><span class="o">(</span><span class="n">è€Œä¸æ˜¯ä»…åˆ é™¤ä¸€æ¬¡æˆ–å‡ æ¬¡</span><span class="o">)</span><span class="err">ï¼Œ</span><span class="n">æœ‰ä»»ä½•åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›true</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">complement</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kt">boolean</span> <span class="n">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">r</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">])</span> <span class="o">==</span> <span class="n">complement</span><span class="o">)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">w</span><span class="o">++]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">];</span>
	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
		<span class="c1">// Preserve behavioral compatibility with AbstractCollection,</span>
		<span class="c1">// even if c.contains() throws.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span>
							 <span class="n">elementData</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span>
							 <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">);</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// clear to let GC do its work</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="n">modCount</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">modified</span><span class="o">;</span>
<span class="o">}</span>
 <span class="c1">//ä¿å­˜æ•°ç»„å®ä¾‹çš„çŠ¶æ€åˆ°ä¸€ä¸ªæµï¼ˆå³å®ƒåºåˆ—åŒ–ï¼‰ã€‚å†™å…¥è¿‡ç¨‹æ•°ç»„è¢«æ›´æ”¹ä¼šæŠ›å‡ºå¼‚å¸¸</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">{</span>
	<span class="c1">// Write out element count, and any hidden stuff</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>

	<span class="c1">// Write out size as capacity for behavioural compatibility with clone()</span>
	<span class="n">s</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

	<span class="c1">// Write out all elements in the proper order.</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//ä¸Šé¢æ˜¯å†™ï¼Œè¿™ä¸ªå°±æ˜¯è¯»äº†ã€‚</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
	<span class="n">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>

	<span class="c1">// Read in size, and any hidden stuff</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

	<span class="c1">// Read in capacity</span>
	<span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> <span class="c1">// ignored</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// be like clone(), allocate array based upon size not capacity</span>
		<span class="n">ensureCapacityInternal</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

		<span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">;</span>
		<span class="c1">// Read in all elements in the proper order.</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">å®ç°Iterable</span>
<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">å®ç°Iterable</span>
<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">Itr</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>//é€šç”¨çš„è¿­ä»£å™¨å®ç° è¿­ä»£å™¨ï¼ˆIteratorï¼‰æ¨¡å¼</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="n">cursor</span><span class="o">;</span>       <span class="c1">// index of next element to return</span>
	<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// index of last element returned; -1 if no such</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="n">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">++]);</span>
		<span class="o">}</span>
		<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…¶ä¸­çš„ListItrç»§æ‰¿Itrï¼Œå®ç°äº†ListIteratoræ¥å£ï¼ŒåŒæ—¶é‡å†™äº†hasPrevious()ï¼ŒnextIndex()ï¼Œ previousIndex()ï¼Œprevious()ï¼Œset(E e)ï¼Œadd(E e)ç­‰æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºäº†Iteratorå’ŒListIteratorçš„åŒºåˆ«ï¼Œå°±æ˜¯ListIteratoråœ¨Iteratorçš„åŸºç¡€ä¸Šå¢åŠ äº†æ·»åŠ å¯¹è±¡ï¼Œä¿®æ”¹å¯¹è±¡ï¼Œé€†å‘éå†ç­‰æ–¹æ³•ï¼Œè¿™äº›æ˜¯Iteratorä¸èƒ½å®ç°çš„ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ListItr</span> <span class="kd">extends</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nc">ListItr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//è¿”å›æŒ‡å®šèŒƒå›´çš„å­æ•°ç»„</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">subListRangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"fromIndex = "</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">toIndex</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"toIndex = "</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&gt;</span> <span class="n">toIndex</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"fromIndex("</span> <span class="o">+</span> <span class="n">fromIndex</span> <span class="o">+</span>
										   <span class="s">") &gt; toIndex("</span> <span class="o">+</span> <span class="n">toIndex</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>å…¶ä¸­çš„SubListç»§æ‰¿AbstractListï¼Œå®ç°äº†RandmAccessæ¥å£ï¼Œç±»å†…éƒ¨å®ç°äº†å¯¹å­åºåˆ—çš„å¢åˆ æ”¹æŸ¥ç­‰æ–¹æ³•ï¼Œä½†å®ƒåŒæ—¶ä¹Ÿå……åˆ†åˆ©ç”¨äº†å†…éƒ¨ç±»çš„ä¼˜ç‚¹ï¼Œå°±æ˜¯å…±äº«ArrayListçš„å…¨å±€å˜é‡ï¼Œä¾‹å¦‚æ£€æŸ¥å™¨å˜é‡modCountï¼Œæ•°ç»„elementDataç­‰ï¼Œæ‰€ä»¥SubListè¿›è¡Œçš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½æ˜¯å¯¹ArrayListçš„æ•°ç»„è¿›è¡Œçš„ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„æ•°ç»„(ä¸æµªè´¹å†…å­˜èµ„æº)ã€‚</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">SubList</span> <span class="kd">extends</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">RandomAccess</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">parentOffset</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

	<span class="nc">SubList</span><span class="o">(</span><span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">,</span>
			<span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parentOffset</span> <span class="o">=</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">result</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">--;</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">removeRange</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">,</span>
						   <span class="n">parentOffset</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">-=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">cSize</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">cSize</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">+=</span> <span class="n">cSize</span><span class="o">;</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">listIterator</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">offset</span><span class="o">;</span>

		<span class="k">return</span> <span class="k">new</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
				<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span><span class="o">++)]);</span>
				<span class="o">}</span>
				<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
				<span class="n">lastRet</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">expectedModCount</span> <span class="o">!=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">};</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span>
										   <span class="n">offset</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//æŒ‰ç…§æ¯”è¾ƒå™¨çš„åˆ¤æ–­é€»è¾‘è¿›è¡Œæ’åº</span>
<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nc">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="no">E</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>
 <span class="n">ä»¥ä¸‹åŸºäº</span> <span class="mf">1.8</span><span class="err">ï¼Œ</span><span class="n">å’Œå‡½æ•°å¼ç¼–ç¨‹ç›¸å…³çš„æ–¹æ³•</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">final</span> <span class="no">E</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">[])</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>


	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span> <span class="c1">// current index, modified on advance/split</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">;</span> <span class="c1">// -1 until used; then one past last index</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span> <span class="c1">// initialized when fence set</span>

	<span class="cm">/** Create new spliterator covering the given  range */</span>
	<span class="nc">ArrayListSpliterator</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">,</span>
						 <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span> <span class="c1">// OK if null unless traversed</span>
		<span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">origin</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fence</span> <span class="o">=</span> <span class="n">fence</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">expectedModCount</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="nf">getFence</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// initialize fence to size on first use</span>
		<span class="kt">int</span> <span class="n">hi</span><span class="o">;</span> <span class="c1">// (a specialized variant appears in method forEach)</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">hi</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">index</span><span class="o">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="n">mid</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="c1">// divide range in half unless too small</span>
			<span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">list</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mid</span><span class="o">,</span>
										<span class="n">expectedModCount</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span><span class="n">list</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
			<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">hi</span><span class="o">,</span> <span class="n">mc</span><span class="o">;</span> <span class="c1">// hoist accesses and checks from loop</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">elementData</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
					<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lst</span><span class="o">.</span><span class="na">modCount</span> <span class="o">==</span> <span class="n">mc</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">getFence</span><span class="o">()</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SIZED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SUBSIZED</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeIf</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
	<span class="c1">// figure out which elements are to be removed</span>
	<span class="c1">// any exception thrown from the filter predicate at this stage</span>
	<span class="c1">// will leave the collection unmodified</span>
	<span class="kt">int</span> <span class="n">removeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">final</span> <span class="nc">BitSet</span> <span class="n">removeSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
		<span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">element</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">removeSet</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">removeCount</span><span class="o">++;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// shift surviving elements left over the spaces left by removed elements</span>
	<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">anyToRemove</span> <span class="o">=</span> <span class="n">removeCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">anyToRemove</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">removeCount</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">newSize</span><span class="o">);</span> <span class="n">i</span><span class="o">++,</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">removeSet</span><span class="o">.</span><span class="na">nextClearBit</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">newSize</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// Let gc do its work</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="n">modCount</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="n">anyToRemove</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replaceAll</span><span class="o">(</span><span class="nc">UnaryOperator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">operator</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="na">apply</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>æ€»ç»“ï¼Œ
  	Listæ¥å£å¯è°ƒæ•´å¤§å°çš„æ•°ç»„å®ç°ã€‚å®ç°æ‰€æœ‰å¯é€‰çš„Listæ“ä½œï¼Œå¹¶å…è®¸æ‰€æœ‰å…ƒç´ ï¼ŒåŒ…æ‹¬nullï¼Œå…ƒç´ å¯é‡å¤ã€‚
  	é™¤äº†åˆ—è¡¨æ¥å£å¤–ï¼Œè¯¥ç±»æä¾›äº†ä¸€ç§æ–¹æ³•æ¥æ“ä½œè¯¥æ•°ç»„çš„å¤§å°æ¥å­˜å‚¨è¯¥åˆ—è¡¨ä¸­çš„æ•°ç»„çš„å¤§å°ã€‚</p>
</div>
<div class="literalblock">
<div class="content">
<pre>æ—¶é—´å¤æ‚åº¦ï¼š
æ–¹æ³•sizeã€isEmptyã€getã€setã€iteratorå’ŒlistIteratorçš„è°ƒç”¨æ˜¯å¸¸æ•°æ—¶é—´çš„ã€‚
	æ·»åŠ åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ã€‚å…¶ä»–æ‰€æœ‰æ“ä½œä¹Ÿéƒ½æ˜¯çº¿æ€§æ—¶é—´å¤æ‚åº¦ã€‚</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>å®¹é‡ï¼š
	æ¯ä¸ªArrayListéƒ½æœ‰å®¹é‡ï¼Œå®¹é‡å¤§å°è‡³å°‘ä¸ºListå…ƒç´ çš„é•¿åº¦ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸º10ã€‚
 å®¹é‡å¯ä»¥è‡ªåŠ¨å¢é•¿ã€‚
 å¦‚æœæå‰çŸ¥é“æ•°ç»„å…ƒç´ è¾ƒå¤šï¼Œå¯ä»¥åœ¨æ·»åŠ å…ƒç´ å‰é€šè¿‡è°ƒç”¨ensureCapacity()æ–¹æ³•æå‰å¢åŠ å®¹é‡ä»¥å‡å°åæœŸå®¹é‡è‡ªåŠ¨å¢é•¿çš„å¼€é”€ã€‚
 ä¹Ÿå¯ä»¥é€šè¿‡å¸¦åˆå§‹å®¹é‡çš„æ„é€ å™¨åˆå§‹åŒ–è¿™ä¸ªå®¹é‡ã€‚</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> çº¿ç¨‹ä¸å®‰å…¨ï¼š
 	ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
 	å¦‚æœéœ€è¦åº”ç”¨åˆ°å¤šçº¿ç¨‹ä¸­ï¼Œéœ€è¦åœ¨å¤–éƒ¨åšåŒæ­¥ã€‚
**æŒ‡å¯¼æ„ä¹‰**
é‚£ç§éå†æ€§èƒ½æ›´ä¼˜ï¼Ÿåº”è¯¥ä½¿ç”¨å“ªç§éå†æ–¹å¼ï¼Ÿ
ã€Šç¼–å†™é«˜è´¨é‡ä»£ç ï¼šæ”¹å–„Javaç¨‹åºçš„151ä¸ªå»ºè®®ã€‹ä¸€ä¹¦è®¤ä¸ºä½¿ç”¨ä¼ ç»Ÿçš„ä¸‹æ ‡éå†æ˜¯ä¼˜äºå¢å¼ºå‹forå¾ªç¯çš„ï¼Œè€Œã€ŠEffective Javaä¸­æ–‡ç‰ˆ ç¬¬2ç‰ˆã€‹æ¨èçš„æ˜¯å¢å¼ºå‹forå¾ªç¯ï¼Œè¯´for-eachå¾ªç¯æ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ä½•è§£ï¼Ÿ
åœ¨ArrayListå¤§å°ä¸ºåä¸‡ä¹‹å‰ï¼Œäº”ç§éå†æ–¹å¼æ—¶é—´æ¶ˆè€—å‡ ä¹ä¸€æ ·
å³ä¾¿åœ¨åƒä¸‡å¤§å°çš„ArrayListä¸­ï¼Œå‡ ç§éå†æ–¹å¼ç›¸å·®ä¹Ÿä¸è¿‡50mså·¦å³ï¼ˆfor-eachå¾ªç¯è¾ƒå¤§ï¼‰ï¼Œä¸”åœ¨å¸¸ç”¨çš„åä¸‡å·¦å³æ—¶é—´å‡ ä¹ç›¸ç­‰ï¼Œè€ƒè™‘foreachç®€æ´çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬å¤§å¯é€‰ç”¨foreachè¿™ç§ç®€ä¾¿æ–¹å¼è¿›è¡Œéå†ã€‚</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./assets/images/compareListLoop.png" alt="compareListLoop">
</div>
</div>
<div class="paragraph">
<p>è¿™æ˜¯å¯¹ArrayListæ•ˆç‡å½±å“æ¯”è¾ƒå¤§çš„ä¸€ä¸ªå› ç´ ã€‚
æ¯å½“æ‰§è¡ŒAddç­‰æ·»åŠ å…ƒç´ çš„æ–¹æ³•ï¼Œéƒ½ä¼šæ£€æŸ¥å†…éƒ¨æ•°ç»„çš„å®¹é‡æ˜¯å¦ä¸å¤Ÿäº†ï¼Œå¦‚æœæ˜¯ï¼Œå®ƒå°±ä¼šä»¥å½“å‰å®¹é‡ çš„ 1.5 å€æ¥é‡æ–°æ„å»ºä¸€ä¸ªæ•°ç»„ï¼Œå°†æ—§å…ƒç´ Copyåˆ°æ–°æ•°ç»„ä¸­ï¼Œç„¶åä¸¢å¼ƒæ—§æ•°ç»„ï¼Œåœ¨è¿™ä¸ªä¸´ç•Œç‚¹çš„æ‰©å®¹æ“ä½œï¼Œåº”è¯¥æ¥è¯´æ˜¯æ¯”è¾ƒå½±å“æ•ˆç‡çš„ã€‚ æ­£ç¡®çš„é¢„ä¼°å¯èƒ½çš„å…ƒç´ ï¼Œæ˜¯æé«˜ArrayListä½¿ç”¨æ•ˆç‡çš„é‡è¦é€”å¾„ã€‚</p>
</div>
</div>
<div class="sect2">
<h3 id="_é—®é¢˜"><a class="anchor" href="#_é—®é¢˜"></a>8.6. é—®é¢˜</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java ä¸­æœ‰å¾ˆå¤šæ ‡è¯†ç±»çš„æ¥å£ã€‚è¿™äº›è¡¨ç¤ºç±»æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿæ˜¯å¦åœ¨ Java è™šæ‹Ÿæœºä¸­å¯¹å…¶è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Ÿ</p>
</li>
<li>
<p>åœ¨å®ç° <code>java.io.Serializable</code> æ—¶ï¼Œå¦‚æœä¸å£°æ˜ <code>serialVersionUID</code> å˜é‡æ—¶ï¼Œæ˜¯å¦ä¼šç”Ÿæˆè¿™ä¸ªå€¼ï¼Ÿé»˜è®¤çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿåœ¨åºåˆ—åŒ–æ—¶ï¼Œæ˜¯å¦‚ä½•ä¿å­˜è¿™ä¸ªå€¼ï¼Ÿåœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚ä½•ä»å¯¹è±¡çš„å­—èŠ‚ç ä¸­è·å–è¿™ä¸ªå€¼ï¼Ÿæ¯”è¾ƒåï¼Œå¦‚æœä¸åŒåˆæ€ä¹ˆå¤„ç†çš„ï¼Ÿ</p>
</li>
<li>
<p>åœ¨ <code>ArrayList</code> ä¸­æœ‰ <code>writeObject(java.io.ObjectOutputStream s)</code> å’Œ <code>readObject(java.io.ObjectInputStream s)</code> æ–¹æ³•ã€‚åœ¨å•ä¾‹æ¨¡å¼ä¸­ï¼Œä¸ºäº†è§£å†³ååºåˆ—åŒ–çš„é—®é¢˜ï¼Œä¼šæ·»åŠ  <code>readResolve()</code> æ–¹æ³•ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ—¶å€™è¢«ä»€ä¹ˆè°ƒç”¨ï¼Ÿè¢«ä»€ä¹ˆè°ƒç”¨ï¼Ÿè®¾ç½®æ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œçœ‹ <strong>è°ƒç”¨æ ˆ</strong>ã€‚</p>
</li>
<li>
<p>ArrayList åœ¨æ‰©å®¹æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ <code>oldCapacity + (oldCapacity &gt;&gt; 1)</code>ï¼Œè¿™é‡Œ <code>oldCapacity &gt;&gt; 1</code> å°±æ˜¯ç›´æ¥ç§»ä½å°† oldCapacity çš„å€¼å‡åŠï¼Œå–åˆ°çš„å€¼å°±æ˜¯ oldCapacity/2 åçš„æœ€å¤§æ­£æ•´æ•°ã€‚</p>
</li>
<li>
<p>ArrayList ä¸­æœ‰ <code>rangeCheck(int index)</code> å’Œ <code>rangeCheckForAdd(int index)</code>ï¼ŒåŒºåˆ«å°±æ˜¯å‰è€…æ²¡æœ‰åšè´Ÿæ•°æ£€æŸ¥ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§åŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆä¸æ£€æŸ¥è´Ÿæ•°ï¼Ÿå†ä¸ºä»€ä¹ˆä¸æ£€æŸ¥è´Ÿæ•°ä¸ºä»€ä¹ˆè¿˜èƒ½æŠ›å‡º <code>ArrayIndexOutOfBoundsException</code> å¼‚å¸¸ï¼Ÿï¼ˆæ–‡æ¡£ä¸­ï¼‰</p>
</li>
<li>
<p>ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æã€‹ ä¸­æåˆ° <code>Iterator</code> å’Œ <code>ListIterator</code> çš„åŒºåˆ«ä»¥åŠ <code>ListIterator</code> ä¸­ä¸€ä¸ªç‰¹æ®Šçš„ä½¿ç”¨ã€‚å†æ¬¡çœ‹ä¹¦æ¥ç¡®è®¤ä¸€ä¸‹ã€‚</p>
</li>
<li>
<p>é€šè¿‡æŒ‡ä»¤æ¥å¯¹æ¯” Iterat or å’Œ foreach ä¹‹é—´çš„æ€§èƒ½å·®å¼‚ã€‚</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_å‚è€ƒèµ„æ–™_2"><a class="anchor" href="#_å‚è€ƒèµ„æ–™_2"></a>8.7. å‚è€ƒèµ„æ–™</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.hollischuang.com/archives/1144">å•ä¾‹ä¸åºåˆ—åŒ–çš„é‚£äº›äº‹å„¿-HollisChuang&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.hollischuang.com/archives/197">æ·±åº¦åˆ†æJavaçš„æšä¸¾ç±»å‹â€”-æšä¸¾çš„çº¿ç¨‹å®‰å…¨æ€§åŠåºåˆ—åŒ–é—®é¢˜-HollisChuang&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>â†Â Previous:Â <a href="java.util.AbstractSequentialList.html">AbstractSequentialList</a>Â | â†‘Â Up:Â <a href="index.html">JDK æºç åˆ†æ</a>Â | Next:Â <a href="java.util.LinkedList.html">LinkedList</a>Â â†’</p>
</div>
<script src="https://giscus.app/client.js" data-repo="diguage/jdk-source-analysis" data-repo-id="MDEwOlJlcG9zaXRvcnk3MjM5MzE5Mw==" data-category="General" data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyMDM2MDQx" data-mapping="og:title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-11-25 13:40:54 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="assets/scripts/asciidoctor-tabs.js"></script>
<script src="assets/scripts/scroll-toc.js"></script></body>
</html>